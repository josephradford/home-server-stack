services:
  homepage:
    image: ghcr.io/gethomepage/homepage:latest
    container_name: homepage
    environment:
      PUID: ${PUID:-1000}
      PGID: ${PGID:-1000}
      # Allow access from any host on local network (disables host validation)
      # For stricter security, set to specific IPs in .env: HOMEPAGE_ALLOWED_HOSTS=192.168.1.100,192.168.1.101
      HOMEPAGE_ALLOWED_HOSTS: ${HOMEPAGE_ALLOWED_HOSTS:-}
      # Pass through environment variables for configs
      HOMEPAGE_VAR_SERVER_IP: ${SERVER_IP}
      HOMEPAGE_VAR_ADGUARD_USER: ${ADGUARD_USERNAME}
      HOMEPAGE_VAR_ADGUARD_PASS: ${ADGUARD_PASSWORD}
      HOMEPAGE_VAR_GRAFANA_USER: ${GRAFANA_USERNAME:-admin}
      HOMEPAGE_VAR_GRAFANA_PASS: ${GRAFANA_PASSWORD}
      HOMEPAGE_VAR_TRANSPORTNSW_KEY: ${TRANSPORTNSW_API_KEY}
      HOMEPAGE_VAR_GCAL_ICAL_URL: ${GOOGLE_CALENDAR_ICAL_URL}
      HOMEPAGE_VAR_HOMEASSISTANT_URL: ${HOMEASSISTANT_URL}
      HOMEPAGE_VAR_HOMEASSISTANT_TOKEN: ${HOMEASSISTANT_TOKEN}
    # No port exposure - access via Traefik at https://homepage.${DOMAIN}
    volumes:
      - ./data/homepage/config:/app/config
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /:/host:ro
    restart: unless-stopped
    networks:
      - homeserver
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.homepage.rule=Host(`homepage.${DOMAIN}`)"
      - "traefik.http.routers.homepage.entrypoints=websecure"
      - "traefik.http.routers.homepage.tls=true"
      # Using file provider certificate (wildcard from certbot)
      - "traefik.http.services.homepage.loadbalancer.server.port=3000"
      # Security: Apply admin-secure middleware without rate limiting
      # Note: Homepage loads multiple widgets simultaneously and may trigger rate limits
      - "traefik.http.routers.homepage.middlewares=admin-secure-no-ratelimit"

networks:
  homeserver:
    driver: bridge
