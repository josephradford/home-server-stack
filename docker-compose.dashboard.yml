services:
  homepage-api:
    build: ./homepage-api
    container_name: homepage-api
    environment:
      # BOM Weather (Australian Bureau of Meteorology)
      # Location search by suburb name (e.g., "parramatta", "sydney", "melbourne")
      BOM_LOCATION: ${BOM_LOCATION:-parramatta}
      # Transport NSW API
      TRANSPORT_NSW_API_KEY: ${TRANSPORT_NSW_API_KEY}
      # Home Assistant
      HOMEASSISTANT_URL: ${HOMEASSISTANT_URL:-http://homeassistant:8123}
      HOMEASSISTANT_TOKEN: ${HOMEASSISTANT_TOKEN}
      # TomTom Traffic API
      TOMTOM_API_KEY: ${TOMTOM_API_KEY}
      # Traffic Routes (dynamically loaded from TRAFFIC_ROUTE_* env vars)
      TRAFFIC_ROUTE_1_NAME: ${TRAFFIC_ROUTE_1_NAME}
      TRAFFIC_ROUTE_1_ORIGIN: ${TRAFFIC_ROUTE_1_ORIGIN}
      TRAFFIC_ROUTE_1_DESTINATION: ${TRAFFIC_ROUTE_1_DESTINATION}
      TRAFFIC_ROUTE_1_SCHEDULE: ${TRAFFIC_ROUTE_1_SCHEDULE:-Daily 00:00-23:59}
      TRAFFIC_ROUTE_2_NAME: ${TRAFFIC_ROUTE_2_NAME}
      TRAFFIC_ROUTE_2_ORIGIN: ${TRAFFIC_ROUTE_2_ORIGIN}
      TRAFFIC_ROUTE_2_DESTINATION: ${TRAFFIC_ROUTE_2_DESTINATION}
      TRAFFIC_ROUTE_2_SCHEDULE: ${TRAFFIC_ROUTE_2_SCHEDULE:-Daily 00:00-23:59}
    # No port exposure - access via Traefik or internal network only
    restart: unless-stopped
    networks:
      - homeserver
    volumes:
      - ./data/homepage-api:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.homepage-api.rule=Host(`homepage-api.${DOMAIN}`)"
      - "traefik.http.routers.homepage-api.entrypoints=websecure"
      - "traefik.http.routers.homepage-api.tls=true"
      # Using file provider certificate (wildcard from certbot)
      - "traefik.http.services.homepage-api.loadbalancer.server.port=5000"
      # Security: Apply admin-secure middleware (IP whitelist + rate limiting)
      - "traefik.http.routers.homepage-api.middlewares=admin-secure"

  homepage:
    image: ghcr.io/gethomepage/homepage:latest
    container_name: homepage
    environment:
      PUID: ${PUID:-1000}
      PGID: ${PGID:-1000}
      # Allow access from any host on local network (disables host validation)
      # For stricter security, set to specific IPs in .env: HOMEPAGE_ALLOWED_HOSTS=192.168.1.100,192.168.1.101
      HOMEPAGE_ALLOWED_HOSTS: ${HOMEPAGE_ALLOWED_HOSTS:-}
      # Pass through environment variables for configs
      HOMEPAGE_VAR_SERVER_IP: ${SERVER_IP}
      HOMEPAGE_VAR_DOMAIN: ${DOMAIN}
      HOMEPAGE_VAR_ADGUARD_USER: ${ADGUARD_USERNAME}
      HOMEPAGE_VAR_ADGUARD_PASS: ${ADGUARD_PASSWORD}
      HOMEPAGE_VAR_GRAFANA_USER: ${GRAFANA_USERNAME:-admin}
      HOMEPAGE_VAR_GRAFANA_PASS: ${GRAFANA_PASSWORD}
      # Calendar
      HOMEPAGE_VAR_GCAL_ICAL_URL: ${GOOGLE_CALENDAR_ICAL_URL}
      # Transport Stops (used in widget URL templates in services.yaml)
      HOMEPAGE_VAR_TRANSPORT_STOP_1_ID: ${TRANSPORT_STOP_1_ID}
      HOMEPAGE_VAR_TRANSPORT_STOP_1_NAME: ${TRANSPORT_STOP_1_NAME}
      HOMEPAGE_VAR_TRANSPORT_STOP_1_ICON: ${TRANSPORT_STOP_1_ICON:-mdi-train}
      HOMEPAGE_VAR_TRANSPORT_STOP_2_ID: ${TRANSPORT_STOP_2_ID}
      HOMEPAGE_VAR_TRANSPORT_STOP_2_NAME: ${TRANSPORT_STOP_2_NAME}
      HOMEPAGE_VAR_TRANSPORT_STOP_2_ICON: ${TRANSPORT_STOP_2_ICON:-mdi-bus}
      # Traffic Routes (used in widget query params in services.yaml)
      # Note: Also configured in homepage-api for schedule-based filtering
      HOMEPAGE_VAR_TRAFFIC_ROUTE_1_NAME: ${TRAFFIC_ROUTE_1_NAME}
      HOMEPAGE_VAR_TRAFFIC_ROUTE_1_ORIGIN: ${TRAFFIC_ROUTE_1_ORIGIN}
      HOMEPAGE_VAR_TRAFFIC_ROUTE_1_DESTINATION: ${TRAFFIC_ROUTE_1_DESTINATION}
      HOMEPAGE_VAR_TRAFFIC_ROUTE_2_NAME: ${TRAFFIC_ROUTE_2_NAME}
      HOMEPAGE_VAR_TRAFFIC_ROUTE_2_ORIGIN: ${TRAFFIC_ROUTE_2_ORIGIN}
      HOMEPAGE_VAR_TRAFFIC_ROUTE_2_DESTINATION: ${TRAFFIC_ROUTE_2_DESTINATION}
    # No port exposure - access via Traefik at https://homepage.${DOMAIN}
    volumes:
      - ./data/homepage/config:/app/config
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /:/host:ro  # Read-only mount for system stats (disk monitoring disabled in widgets)
    restart: unless-stopped
    networks:
      - homeserver
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.homepage.rule=Host(`homepage.${DOMAIN}`)"
      - "traefik.http.routers.homepage.entrypoints=websecure"
      - "traefik.http.routers.homepage.tls=true"
      # Using file provider certificate (wildcard from certbot)
      - "traefik.http.services.homepage.loadbalancer.server.port=3000"
      # Security: Apply admin-secure middleware without rate limiting
      # Note: Homepage loads multiple widgets simultaneously and may trigger rate limits
      - "traefik.http.routers.homepage.middlewares=admin-secure-no-ratelimit"

networks:
  homeserver:
    driver: bridge
