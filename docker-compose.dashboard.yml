services:
  homepage-api:
    build: ./homepage-api
    container_name: homepage-api
    environment:
      # BOM Weather (Australian Bureau of Meteorology)
      # Location search by suburb name (e.g., "parramatta", "sydney", "melbourne")
      BOM_LOCATION: ${BOM_LOCATION:-parramatta}
      # Transport NSW API
      TRANSPORT_NSW_API_KEY: ${TRANSPORTNSW_API_KEY}
      # Home Assistant
      HOMEASSISTANT_URL: ${HOMEASSISTANT_URL:-http://homeassistant:8123}
      HOMEASSISTANT_TOKEN: ${HOMEASSISTANT_TOKEN}
      # TomTom Traffic API
      TOMTOM_API_KEY: ${TOMTOM_API_KEY}
    # No port exposure - access via Traefik or internal network only
    restart: unless-stopped
    networks:
      - homeserver
    volumes:
      - ./data/homepage-api:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.homepage-api.rule=Host(`homepage-api.${DOMAIN}`)"
      - "traefik.http.routers.homepage-api.entrypoints=websecure"
      - "traefik.http.routers.homepage-api.tls=true"
      # Using file provider certificate (wildcard from certbot)
      - "traefik.http.services.homepage-api.loadbalancer.server.port=5000"
      # Security: Apply admin-secure middleware (IP whitelist + rate limiting)
      - "traefik.http.routers.homepage-api.middlewares=admin-secure"

  homepage:
    image: ghcr.io/gethomepage/homepage:latest
    container_name: homepage
    environment:
      PUID: ${PUID:-1000}
      PGID: ${PGID:-1000}
      # Allow access from any host on local network (disables host validation)
      # For stricter security, set to specific IPs in .env: HOMEPAGE_ALLOWED_HOSTS=192.168.1.100,192.168.1.101
      HOMEPAGE_ALLOWED_HOSTS: ${HOMEPAGE_ALLOWED_HOSTS:-}
      # Pass through environment variables for configs
      HOMEPAGE_VAR_SERVER_IP: ${SERVER_IP}
      HOMEPAGE_VAR_ADGUARD_USER: ${ADGUARD_USERNAME}
      HOMEPAGE_VAR_ADGUARD_PASS: ${ADGUARD_PASSWORD}
      HOMEPAGE_VAR_GRAFANA_USER: ${GRAFANA_USERNAME:-admin}
      HOMEPAGE_VAR_GRAFANA_PASS: ${GRAFANA_PASSWORD}
      HOMEPAGE_VAR_TRANSPORTNSW_KEY: ${TRANSPORTNSW_API_KEY}
      HOMEPAGE_VAR_GCAL_ICAL_URL: ${GOOGLE_CALENDAR_ICAL_URL}
      HOMEPAGE_VAR_HOMEASSISTANT_URL: ${HOMEASSISTANT_URL}
      HOMEPAGE_VAR_HOMEASSISTANT_TOKEN: ${HOMEASSISTANT_TOKEN}
    # No port exposure - access via Traefik at https://homepage.${DOMAIN}
    volumes:
      - ./data/homepage/config:/app/config
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /:/host:ro
    restart: unless-stopped
    networks:
      - homeserver
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.homepage.rule=Host(`homepage.${DOMAIN}`)"
      - "traefik.http.routers.homepage.entrypoints=websecure"
      - "traefik.http.routers.homepage.tls=true"
      # Using file provider certificate (wildcard from certbot)
      - "traefik.http.services.homepage.loadbalancer.server.port=3000"
      # Security: Apply admin-secure middleware (IP whitelist + rate limiting)
      - "traefik.http.routers.homepage.middlewares=admin-secure"

networks:
  homeserver:
    driver: bridge
