# Add Image Vulnerability Scanning to CI/CD

## Priority: 2 (High)
## Estimated Time: 3-4 hours
## Phase: Week 3-4 - High Priority Security

## Description
Integrate Trivy or Grype vulnerability scanning into CI/CD pipeline to detect CVEs in Docker images before deployment. Automate security scanning for all pull requests and scheduled scans for production images.

## Acceptance Criteria
- [ ] Trivy integrated into GitHub Actions
- [ ] All Docker images scanned on PR and push
- [ ] Critical vulnerabilities block merges
- [ ] Scan results published as artifacts
- [ ] SBOM (Software Bill of Materials) generated
- [ ] Scheduled weekly scans for deployed images
- [ ] Vulnerability database auto-updated

## Technical Implementation Details

### Files to Create/Modify
1. `.github/workflows/vulnerability-scan.yml` - CI/CD scanning workflow (new file)
2. `.github/workflows/scheduled-scan.yml` - Weekly production scans (new file)
3. `.trivyignore` - Known false positives (new file)
4. `scripts/local-scan.sh` - Local scanning script (new file)

### GitHub Actions Workflow

**.github/workflows/vulnerability-scan.yml:**
```yaml
name: Container Vulnerability Scanning

on:
  pull_request:
    paths:
      - 'docker-compose*.yml'
      - 'Dockerfile*'
  push:
    branches: [ main ]
    paths:
      - 'docker-compose*.yml'
      - 'Dockerfile*'
  workflow_dispatch:

jobs:
  extract-images:
    runs-on: ubuntu-latest
    outputs:
      images: ${{ steps.extract.outputs.images }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract images from docker-compose files
        id: extract
        run: |
          images=$(grep -hPo 'image:\s*\K[^\s]+' docker-compose*.yml | sort -u | jq -R . | jq -s -c .)
          echo "images=$images" >> $GITHUB_OUTPUT

  scan-images:
    needs: extract-images
    runs-on: ubuntu-latest
    strategy:
      matrix:
        image: ${{ fromJson(needs.extract-images.outputs.images) }}
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.image }}
          format: 'sarif'
          output: 'trivy-results-${{ hashFiles(matrix.image) }}.sarif'
          severity: 'CRITICAL,HIGH'
          vuln-type: 'os,library'
          ignore-unfixed: true

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results-${{ hashFiles(matrix.image) }}.sarif'

      - name: Generate JSON report
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.image }}
          format: 'json'
          output: 'trivy-report-${{ hashFiles(matrix.image) }}.json'
          severity: 'UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL'

      - name: Upload scan results
        uses: actions/upload-artifact@v3
        with:
          name: trivy-scan-results
          path: trivy-*.json

      - name: Check for CRITICAL vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.image }}
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL'
          ignore-unfixed: true

  generate-sbom:
    needs: extract-images
    runs-on: ubuntu-latest
    strategy:
      matrix:
        image: ${{ fromJson(needs.extract-images.outputs.images) }}
    steps:
      - name: Generate SBOM with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.image }}
          format: 'cyclonedx'
          output: 'sbom-${{ hashFiles(matrix.image) }}.json'

      - name: Upload SBOM
        uses: actions/upload-artifact@v3
        with:
          name: sbom-artifacts
          path: sbom-*.json

  summary:
    needs: [scan-images, generate-sbom]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download scan results
        uses: actions/download-artifact@v3
        with:
          name: trivy-scan-results

      - name: Generate summary report
        run: |
          echo "# Vulnerability Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          for file in trivy-report-*.json; do
            image=$(jq -r '.ArtifactName' "$file")
            critical=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' "$file")
            high=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="HIGH")] | length' "$file")
            medium=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' "$file")

            echo "## $image" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”´ Critical: $critical" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŸ  High: $high" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŸ¡ Medium: $medium" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          done
```

### Scheduled Production Scanning

**.github/workflows/scheduled-scan.yml:**
```yaml
name: Weekly Production Image Scan

on:
  schedule:
    # Run every Monday at 3 AM UTC
    - cron: '0 3 * * 1'
  workflow_dispatch:

jobs:
  scan-running-containers:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract and scan all images
        run: |
          images=$(grep -hPo 'image:\s*\K[^\s]+' docker-compose*.yml | sort -u)

          for image in $images; do
            echo "Scanning $image..."
            docker pull "$image"

            trivy image \
              --severity CRITICAL,HIGH \
              --format json \
              --output "scan-${image//[\/:]/-}.json" \
              "$image"
          done

      - name: Check for critical issues
        run: |
          critical_found=false

          for file in scan-*.json; do
            critical=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' "$file")
            if [ "$critical" -gt 0 ]; then
              echo "âŒ CRITICAL vulnerabilities found in $file"
              critical_found=true
            fi
          done

          if $critical_found; then
            echo "Creating GitHub issue for critical vulnerabilities..."
            # Use GitHub CLI or API to create issue
          fi

      - name: Send notification
        if: failure()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "âš ï¸ Critical vulnerabilities detected in production images!",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "Weekly security scan found critical vulnerabilities. Check GitHub Actions for details."
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
```

### Trivy Ignore File

**.trivyignore:**
```
# Trivy Ignore File - Document all ignored vulnerabilities with justification

# Example: Ignore specific CVE in AdGuard (fixed in next release)
# CVE-2024-12345

# Unfixable vulnerabilities in base images (document and monitor)
# CVE-2024-99999  # Alpine base image, no fix available, low exploitability
```

### Local Scanning Script

**scripts/local-scan.sh:**
```bash
#!/bin/bash
# Local vulnerability scanning script

set -e

echo "ðŸ” Scanning Docker images for vulnerabilities..."

# Install Trivy if not present
if ! command -v trivy &> /dev/null; then
    echo "Installing Trivy..."
    curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
fi

# Extract images from docker-compose files
images=$(grep -hPo 'image:\s*\K[^\s]+' docker-compose*.yml | sort -u)

mkdir -p scan-results

for image in $images; do
    echo ""
    echo "ðŸ“¦ Scanning: $image"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

    # Pull latest image
    docker pull "$image" > /dev/null 2>&1 || true

    # Scan for vulnerabilities
    trivy image \
        --severity CRITICAL,HIGH \
        --format table \
        "$image"

    # Generate JSON report
    trivy image \
        --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL \
        --format json \
        --output "scan-results/${image//[\/:]/-}.json" \
        "$image"

    # Generate SBOM
    trivy image \
        --format cyclonedx \
        --output "scan-results/sbom-${image//[\/:]/-}.json" \
        "$image"
done

echo ""
echo "âœ… Scan complete! Results saved to scan-results/"
echo ""
echo "ðŸ“Š Summary:"
for file in scan-results/*.json; do
    if [[ $file != *"sbom"* ]]; then
        image=$(basename "$file" .json)
        critical=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' "$file")
        high=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="HIGH")] | length' "$file")

        if [ "$critical" -gt 0 ] || [ "$high" -gt 0 ]; then
            echo "  $image: ðŸ”´ $critical critical, ðŸŸ  $high high"
        fi
    fi
done
```

### Testing Commands
```bash
# Make script executable
chmod +x scripts/local-scan.sh

# Run local scan
./scripts/local-scan.sh

# Scan specific image
trivy image adguard/adguardhome:latest

# Scan with SARIF output (for IDE integration)
trivy image --format sarif -o results.sarif n8nio/n8n:latest

# Update vulnerability database
trivy image --download-db-only

# Generate SBOM
trivy image --format cyclonedx -o sbom.json ollama/ollama:latest

# Test GitHub Actions locally (using act)
act pull_request -j scan-images
```

## Success Metrics
- All images scanned automatically on PR
- Critical vulnerabilities block deployment
- Weekly production scans running
- SBOMs generated for all images
- Scan results accessible in GitHub Security tab

## Dependencies
- GitHub Actions enabled
- Trivy or Grype installed
- Docker images defined in docker-compose files

## Risk Considerations
- **False Positives**: May block legitimate updates
- **Build Time**: Scanning adds 2-5 minutes per image
- **Database Updates**: Requires internet access
- **Unfixable CVEs**: Base image vulnerabilities may be unavoidable

## Rollback Plan
```bash
# Disable vulnerability scanning workflow
git mv .github/workflows/vulnerability-scan.yml .github/workflows/vulnerability-scan.yml.disabled

# Skip checks on specific PR
# Add [skip scan] to commit message
```

## Security Impact
- **Before**: Unknown vulnerabilities in production images
- **After**: Continuous vulnerability monitoring and blocking
- **Risk Reduction**: 80% reduction in known CVE exposure

## References
- [Trivy Documentation](https://aquasecurity.github.io/trivy/)
- [Grype Documentation](https://github.com/anchore/grype)
- [SBOM Best Practices](https://www.cisa.gov/sbom)

## Follow-up Tasks
- Integrate with vulnerability management platform
- Create vulnerability remediation playbook
- Set up automatic image rebuilds on CVE fixes
- Implement runtime vulnerability scanning
