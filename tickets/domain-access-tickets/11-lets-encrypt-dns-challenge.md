# Ticket 11: Configure Let's Encrypt with DNS Challenge for Trusted Certificates

**Priority:** Medium
**Estimated Time:** 2-3 hours
**Category:** Security & UX Enhancement
**Status:** ⬜ Pending
**Dependencies:** Tickets 01-08 complete, working domain-based access

## Overview

Replace self-signed SSL certificates with trusted Let's Encrypt certificates using DNS-01 challenge. This eliminates browser certificate warnings and enables proper favicon caching in Safari and other browsers.

## Problem Statement

**Current Situation:**
- Services use self-signed certificates generated by Traefik
- Browsers show certificate warnings on every visit
- Safari requires accepting certificates repeatedly
- Favicons don't save to bookmarks due to untrusted certificates
- Poor user experience for accessing services

**Goal:**
- Use real, trusted SSL certificates from Let's Encrypt
- Eliminate all browser certificate warnings
- Enable proper favicon caching
- Improve overall UX for local network access

## Prerequisites

### Required
1. **Domain name ownership**: You must own a real domain (e.g., `example.com`)
2. **DNS provider with API access**: Supported providers include:
   - Cloudflare (recommended - easiest)
   - Route53 (AWS)
   - Digital Ocean
   - Google Cloud DNS
   - [100+ others supported by Traefik](https://doc.traefik.io/traefik/https/acme/#providers)
3. **API credentials**: API key/token for your DNS provider

### Recommended Setup
- **Subdomain structure**: Use `*.home.example.com` for local services
- **DNS configuration**:
  - Public DNS: `*.home.example.com` → A record to your public IP (for Let's Encrypt validation only)
  - Local DNS (AdGuard): `*.home.example.com` → 192.168.1.101 (for actual access)

## Technical Approach: DNS-01 Challenge

### Why DNS Challenge?

**DNS-01 challenge** is ideal for local services because:
- ✅ Works without exposing services to the internet
- ✅ Validates domain ownership via DNS TXT records
- ✅ Supports wildcard certificates (`*.home.example.com`)
- ✅ No need to open ports 80/443 to the internet
- ✅ Services remain 100% local-only

**How it works:**
1. Traefik requests certificate from Let's Encrypt
2. Let's Encrypt asks: "Prove you own `home.example.com`"
3. Traefik creates DNS TXT record via your DNS provider's API
4. Let's Encrypt checks the TXT record
5. Certificate issued and auto-renewed every 90 days

### Alternative: HTTP-01 Challenge (NOT Recommended)

HTTP-01 requires:
- Exposing port 80/443 to the internet
- Port forwarding on your router
- Services publicly accessible (security risk)
- Individual certificates per domain (no wildcards)

**We do NOT use this approach.**

## Implementation Steps

### Step 1: Choose DNS Provider & Get API Credentials

**Option A: Cloudflare (Recommended)**
```bash
# 1. Sign up for Cloudflare (free tier is fine)
# 2. Add your domain to Cloudflare
# 3. Update nameservers at your domain registrar
# 4. Create API token:
#    - Go to: https://dash.cloudflare.com/profile/api-tokens
#    - Click "Create Token"
#    - Use template: "Edit zone DNS"
#    - Permissions: Zone > DNS > Edit
#    - Zone Resources: Include > Specific zone > yourdomain.com
#    - Copy the token (you won't see it again!)
```

**Option B: AWS Route53**
```bash
# 1. Create IAM user with Route53 permissions
# 2. Attach policy: AmazonRoute53FullAccess (or custom restricted policy)
# 3. Generate access key and secret
# 4. Note: AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY
```

**Option C: Other providers**
- See [Traefik ACME docs](https://doc.traefik.io/traefik/https/acme/#providers) for your provider
- Each provider has different environment variable requirements

### Step 2: Update DNS Configuration

**In your DNS provider (e.g., Cloudflare):**

1. Create subdomain for home services:
   ```
   Type: A
   Name: *.home
   Content: <your-public-ip>  # or any IP (Let's Encrypt just checks DNS, doesn't connect)
   TTL: Auto
   Proxy: DNS only (disable Cloudflare proxy)
   ```

2. Verify DNS propagation:
   ```bash
   dig hortusfox.home.example.com
   # Should return the A record
   ```

**In AdGuard Home (local DNS):**

Update DNS rewrites to use new domain:
```
*.home.example.com → 192.168.1.101
```

Or keep existing `.home.local` and add new domain:
```
*.home.example.com → 192.168.1.101  # For Let's Encrypt certificates
*.home.local → 192.168.1.101        # Keep for backward compatibility
```

### Step 3: Update Environment Variables

Add to `.env`:

```bash
# Let's Encrypt Configuration
ACME_EMAIL=your-email@example.com

# Cloudflare API Token (if using Cloudflare)
CF_API_EMAIL=your-cloudflare-email@example.com
CF_DNS_API_TOKEN=your_cloudflare_api_token_here

# OR for AWS Route53 (if using Route53)
# AWS_ACCESS_KEY_ID=your_access_key
# AWS_SECRET_ACCESS_KEY=your_secret_key
# AWS_REGION=us-east-1
# AWS_HOSTED_ZONE_ID=your_zone_id

# Domain for services
HOME_DOMAIN=home.example.com
```

Add to `.env.example`:

```bash
# Let's Encrypt SSL Certificates
# Used to obtain trusted certificates via DNS challenge
ACME_EMAIL=admin@example.com

# DNS Provider API Credentials (choose one)
# Cloudflare (recommended)
CF_API_EMAIL=your-cloudflare-email@example.com
CF_DNS_API_TOKEN=your_cloudflare_api_token

# OR AWS Route53
# AWS_ACCESS_KEY_ID=your_aws_access_key
# AWS_SECRET_ACCESS_KEY=your_aws_secret_key
# AWS_REGION=us-east-1
# AWS_HOSTED_ZONE_ID=Z1234567890ABC

# Home services domain (must own this domain)
HOME_DOMAIN=home.example.com
```

### Step 4: Update Traefik Configuration

**File:** `docker-compose.yml`

Update the Traefik service:

```yaml
traefik:
  image: traefik:v3.0
  container_name: traefik
  restart: unless-stopped
  command:
    # API and Dashboard
    - "--api.dashboard=true"
    - "--api.insecure=false"

    # Docker provider
    - "--providers.docker=true"
    - "--providers.docker.exposedbydefault=false"

    # Entrypoints
    - "--entrypoints.web.address=:80"
    - "--entrypoints.websecure.address=:443"

    # HTTP to HTTPS redirect
    - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
    - "--entrypoints.web.http.redirections.entrypoint.scheme=https"

    # TLS
    - "--entrypoints.websecure.http.tls=true"

    # Let's Encrypt Certificate Resolver
    - "--certificatesresolvers.letsencrypt.acme.dnschallenge=true"
    - "--certificatesresolvers.letsencrypt.acme.dnschallenge.provider=cloudflare"
    - "--certificatesresolvers.letsencrypt.acme.dnschallenge.resolvers=1.1.1.1:53,8.8.8.8:53"
    - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL}"
    - "--certificatesresolvers.letsencrypt.acme.storage=/certs/acme.json"
    # REMOVE THIS LINE FOR PRODUCTION (staging for testing):
    # - "--certificatesresolvers.letsencrypt.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory"

    # Ping endpoint for health checks
    - "--ping=true"

    # Logging
    - "--accesslog=true"
    - "--accesslog.filepath=/var/log/traefik/access.log"
    - "--log.level=INFO"

  ports:
    - "${SERVER_IP}:80:80"
    - "${SERVER_IP}:443:443"

  environment:
    # Cloudflare credentials (if using Cloudflare)
    - CF_API_EMAIL=${CF_API_EMAIL}
    - CF_DNS_API_TOKEN=${CF_DNS_API_TOKEN}

    # OR Route53 credentials (if using AWS)
    # - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
    # - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
    # - AWS_REGION=${AWS_REGION}
    # - AWS_HOSTED_ZONE_ID=${AWS_HOSTED_ZONE_ID}

  volumes:
    - /var/run/docker.sock:/var/run/docker.sock:ro
    - ./data/traefik/certs:/certs
    - ./data/traefik/logs:/var/log/traefik
    - ./config/traefik:/etc/traefik:ro

  networks:
    - homeserver

  labels:
    # Enable Traefik for the dashboard
    - "traefik.enable=true"

    # Dashboard router
    - "traefik.http.routers.dashboard.rule=Host(`traefik.${HOME_DOMAIN}`)"
    - "traefik.http.routers.dashboard.entrypoints=websecure"
    - "traefik.http.routers.dashboard.tls=true"
    - "traefik.http.routers.dashboard.tls.certresolver=letsencrypt"
    - "traefik.http.routers.dashboard.service=api@internal"

    # Dashboard middleware (basic auth)
    - "traefik.http.middlewares.dashboard-auth.basicauth.users=admin:$$1$$3TOX7HzuCTU"
    - "traefik.http.routers.dashboard.middlewares=dashboard-auth"

  healthcheck:
    test: ["CMD", "traefik", "healthcheck", "--ping"]
    interval: 30s
    timeout: 10s
    retries: 3
    start_period: 10s
```

**Key changes:**
1. Added certificate resolver configuration for Let's Encrypt
2. Configured DNS challenge with Cloudflare provider
3. Added environment variables for DNS API credentials
4. Added `tls.certresolver=letsencrypt` to Traefik dashboard labels

### Step 5: Update Service Labels

Update each service to use the Let's Encrypt cert resolver.

**Example: HortusFox**

```yaml
hortusfox:
  # ... existing config ...
  labels:
    - "traefik.enable=true"

    # HTTP Router
    - "traefik.http.routers.hortusfox-http.rule=Host(`hortusfox.${HOME_DOMAIN}`)"
    - "traefik.http.routers.hortusfox-http.entrypoints=web"
    - "traefik.http.routers.hortusfox-http.middlewares=redirect-to-https"

    # HTTPS Router
    - "traefik.http.routers.hortusfox.rule=Host(`hortusfox.${HOME_DOMAIN}`)"
    - "traefik.http.routers.hortusfox.entrypoints=websecure"
    - "traefik.http.routers.hortusfox.tls=true"
    - "traefik.http.routers.hortusfox.tls.certresolver=letsencrypt"  # ADD THIS LINE

    # Service
    - "traefik.http.services.hortusfox.loadbalancer.server.port=80"
```

**Apply to all services:**
- Glance
- HortusFox
- Grafana
- n8n
- AdGuard
- Ollama
- Habitica
- Prometheus
- Alertmanager

### Step 6: Create acme.json File

```bash
# On the server
touch data/traefik/certs/acme.json
chmod 600 data/traefik/certs/acme.json
```

This file stores Let's Encrypt certificates and must have strict permissions.

### Step 7: Test with Staging First (Recommended)

Let's Encrypt has rate limits (50 certs/week). Test with staging first:

1. Add staging server to Traefik config:
   ```yaml
   - "--certificatesresolvers.letsencrypt.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory"
   ```

2. Deploy and test:
   ```bash
   docker compose down
   docker compose up -d

   # Wait 30-60 seconds for certificate generation
   docker logs traefik | grep acme
   ```

3. Visit `https://hortusfox.home.example.com`
   - Should show certificate from "Fake LE Intermediate X1"
   - Still shows warning (expected - it's staging)
   - Confirms DNS challenge is working

4. If successful, remove staging line and redeploy for production certs

### Step 8: Deploy Production Certificates

1. Remove staging server line from docker-compose.yml
2. Delete acme.json to start fresh:
   ```bash
   rm data/traefik/certs/acme.json
   touch data/traefik/certs/acme.json
   chmod 600 data/traefik/certs/acme.json
   ```

3. Restart Traefik:
   ```bash
   docker compose down
   docker compose up -d
   ```

4. Monitor certificate generation:
   ```bash
   docker logs traefik -f | grep acme
   ```

5. Verify in browser - should show trusted certificate!

## Testing Checklist

### DNS Configuration
- [ ] `dig hortusfox.home.example.com` returns A record
- [ ] AdGuard DNS rewrite configured for `*.home.example.com`
- [ ] Local DNS resolution works: `dig @192.168.1.101 hortusfox.home.example.com`

### Certificate Generation (Staging)
- [ ] Traefik logs show "Trying to challenge" messages
- [ ] Traefik logs show "Validations succeeded"
- [ ] `acme.json` contains certificate data
- [ ] Browser shows "Fake LE Intermediate X1" certificate
- [ ] No rate limit errors in logs

### Certificate Generation (Production)
- [ ] Traefik logs show successful validation
- [ ] Browser shows trusted "Let's Encrypt" certificate
- [ ] No certificate warnings in Safari
- [ ] Favicons save to bookmarks
- [ ] Certificate valid for 90 days

### All Services
- [ ] All services accessible via `https://*.home.example.com`
- [ ] All services show trusted certificate
- [ ] No certificate warnings
- [ ] HTTP redirects to HTTPS
- [ ] Favicons display and save properly

## Troubleshooting

### Issue: "Error getting certificate: 429 Too Many Requests"

**Cause:** Hit Let's Encrypt rate limit (50 certs/week)

**Solution:**
- Wait 7 days for rate limit to reset
- Use staging environment for testing
- Request wildcard certificate to use single cert for all services

### Issue: "DNS problem: NXDOMAIN looking up TXT for _acme-challenge.home.example.com"

**Cause:** DNS not configured correctly or not propagated

**Solution:**
```bash
# Test DNS propagation
dig TXT _acme-challenge.home.example.com

# Check Traefik can reach DNS provider API
docker exec traefik ping 1.1.1.1

# Verify API credentials are correct
docker exec traefik env | grep CF_
```

### Issue: "context deadline exceeded"

**Cause:** Timeout waiting for DNS propagation

**Solution:**
- Increase DNS challenge timeout in Traefik config
- Check DNS provider API is responding
- Verify no firewall blocking Traefik's DNS queries

### Issue: Certificates not auto-renewing

**Cause:** Traefik checks renewal ~30 days before expiry

**Solution:**
- Monitor `acme.json` modification time
- Check Traefik logs for renewal attempts
- Verify DNS API credentials still valid
- Force renewal by deleting cert from `acme.json`

## Wildcard Certificates (Advanced)

To use a single certificate for all services:

```yaml
# In Traefik labels
- "traefik.http.routers.dashboard.tls.domains[0].main=home.example.com"
- "traefik.http.routers.dashboard.tls.domains[0].sans=*.home.example.com"
```

This requests one certificate valid for both `home.example.com` and `*.home.example.com`.

**Benefits:**
- Only one certificate to manage
- Faster initial generation
- Avoids rate limits

**Note:** Only include this on ONE service (e.g., Traefik dashboard). Other services automatically use the same cert.

## Security Considerations

### DNS API Token Security

**Best Practices:**
- ✅ Use minimal permissions (DNS edit only, specific zone only)
- ✅ Store in `.env` (gitignored)
- ✅ Never commit to git
- ✅ Rotate tokens periodically
- ❌ Don't use global API key (too permissive)

### Certificate Storage

**File:** `data/traefik/certs/acme.json`
- Contains private keys
- Must have `chmod 600` permissions
- Should be in `.gitignore`
- Backup securely (contains your certs)

### Public DNS Records

**Note:** Having `*.home.example.com` in public DNS does NOT expose your services:
- DNS only resolves to your public IP
- No ports forwarded = no access from internet
- Local DNS (AdGuard) resolves to local IP
- Services remain local-only

## Cost Analysis

### Free Tier Comparison

| Provider | Free Tier | Limit |
|----------|-----------|-------|
| Cloudflare DNS | ✅ Yes | Unlimited domains |
| Route53 | ❌ No | $0.50/month per hosted zone + queries |
| Digital Ocean | ❌ No | Requires droplet ($4/month) |

**Recommendation:** Use Cloudflare for free DNS + API access

### Let's Encrypt Costs

- ✅ **Free** forever
- ✅ Auto-renewal every 90 days
- ✅ Wildcard certificates included
- ⚠️ Rate limits: 50 certs/week (generous for home use)

## Migration Plan

### Phase 1: Test with One Service (1 hour)
1. Set up DNS provider and get API credentials
2. Configure Traefik with staging environment
3. Test with one service (e.g., Traefik dashboard)
4. Verify certificate generation works

### Phase 2: Deploy to All Services (30 min)
1. Switch to production Let's Encrypt
2. Update all service labels
3. Restart stack
4. Verify all certificates

### Phase 3: Update Documentation (30 min)
1. Update docs with new domain names
2. Update test scripts
3. Update README

## Rollback Plan

If issues occur:

```bash
# 1. Remove Let's Encrypt config from Traefik
# 2. Remove certresolver from service labels
# 3. Restart stack
docker compose down
docker compose up -d

# 4. Services fall back to Traefik's self-signed certs
# 5. Everything works as before (with warnings)
```

## Success Criteria

- ✅ All services accessible via `https://*.home.example.com`
- ✅ Trusted certificates from Let's Encrypt
- ✅ No browser certificate warnings
- ✅ Favicons save to bookmarks in Safari
- ✅ Certificates auto-renew before expiry
- ✅ No services exposed to internet
- ✅ Local-only access maintained

## Related Documentation

- [Traefik Let's Encrypt Guide](https://doc.traefik.io/traefik/https/acme/)
- [Traefik DNS Challenge Providers](https://doc.traefik.io/traefik/https/acme/#providers)
- [Let's Encrypt Rate Limits](https://letsencrypt.org/docs/rate-limits/)
- [Cloudflare API Tokens](https://developers.cloudflare.com/fundamentals/api/get-started/create-token/)

## Alternative: mkcert (Simpler but Device-Specific)

If you don't want to use a real domain, consider mkcert:
- Locally-trusted certificates
- Works without domain ownership
- Must install CA on each device
- See separate ticket or documentation

---

**Created:** 2025-01-15
**Target Completion:** Optional enhancement (post-ticket 10)
