# Update Documentation for Domain-Based Access

## Priority: 2 (High)
## Estimated Time: 1.5-2 hours
## Phase: Week 3 - Finalization

## Description
Update all project documentation to reflect the new domain-based access method. This includes README files, setup guides, operations documentation, and any references to IP:port access patterns.

## Acceptance Criteria
- [ ] README.md updated with new domain-based URLs
- [ ] SETUP.md updated with domain access instructions
- [ ] CONFIGURATION.md includes Traefik configuration details
- [ ] OPERATIONS.md updated for Traefik management
- [ ] ARCHITECTURE.md includes Traefik in infrastructure diagram
- [ ] TROUBLESHOOTING.md includes domain access issues
- [ ] SERVICES.md updated with new access URLs
- [ ] All documentation consistent and accurate
- [ ] Examples updated to use domain names
- [ ] Old IP:port references marked as deprecated (but still documented)

## Files to Update

### 1. README.md

**Sections to update:**

#### Services Access Section
**Current:**
```markdown
**Access Services:**
- AdGuard Home: `http://SERVER_IP:80`
- n8n: `https://SERVER_IP:5678`
- Ollama API: `http://SERVER_IP:11434`
- Habitica: `http://SERVER_IP:8080`
- Bookwyrm: `http://SERVER_IP:8000`
- HortusFox: `http://SERVER_IP:8181`
- Glance: `http://SERVER_IP:8282`
- Grafana: `http://SERVER_IP:3001`
- Prometheus: `http://SERVER_IP:9090`
- Alertmanager: `http://SERVER_IP:9093`
```

**New:**
```markdown
**Access Services:**

All services are accessible via domain names on your local network:

- **Traefik Dashboard:** `https://traefik.home.local`
- **AdGuard Home:** `https://adguard.home.local` (DNS admin)
- **n8n:** `https://n8n.home.local` (Workflow automation)
- **Glance:** `https://glance.home.local` (Dashboard)
- **HortusFox:** `https://hortusfox.home.local` (Plant management)
- **Habitica:** `https://habitica.home.local` (Habit tracker)
- **Bookwyrm:** `https://bookwyrm.home.local` (Book tracking)
- **Ollama API:** `https://ollama.home.local` (AI models)
- **Grafana:** `https://grafana.home.local` (Monitoring)
- **Prometheus:** `https://prometheus.home.local` (Metrics)
- **Alertmanager:** `https://alerts.home.local` (Alerts)

**Note:** Services are accessible via domain names thanks to Traefik reverse proxy and AdGuard Home DNS. Your devices must use AdGuard Home as their DNS server (configured automatically if DHCP points to the server).

**Legacy Access:** Services are still accessible via IP:port for backward compatibility:
- AdGuard Home: `http://SERVER_IP:8888`
- n8n: `https://SERVER_IP:5678`
- And so on... (See [SERVICES.md](SERVICES.md) for complete list)
```

#### Quick Start Section
Add note about SSL certificates:
```markdown
**Note:**
- SSL certificates are self-signed for local network use
- You'll need to accept security warnings in your browser on first visit
- This is normal and expected for local-only services
- For browsers that don't allow proceeding, see [TROUBLESHOOTING.md](docs/TROUBLESHOOTING.md#ssl-certificate-issues)
```

### 2. docs/SETUP.md

Add new section after initial setup:

```markdown
## Domain-Based Access Setup

The home server uses Traefik reverse proxy to provide clean domain-based URLs for all services.

### How It Works

1. **Traefik** acts as a reverse proxy, routing requests based on domain names
2. **AdGuard Home** provides DNS resolution for `*.home.local` domains
3. **Self-signed SSL certificates** are automatically generated by Traefik

### DNS Configuration

Your client devices need to use AdGuard Home as their DNS server:

**Option 1: DHCP (Recommended)**
Configure your router's DHCP to point to AdGuard Home:
- Primary DNS: `SERVER_IP` (e.g., 192.168.1.100)
- Secondary DNS: 1.1.1.1 or 8.8.8.8 (for redundancy)

**Option 2: Manual Configuration**
Set DNS manually on each device to `SERVER_IP`

**Verify DNS Setup:**
```bash
nslookup glance.home.local
# Should return: SERVER_IP
```

### SSL Certificate Warnings

Since certificates are self-signed for local use, you'll see security warnings:

**Chrome/Edge:**
Click "Advanced" → "Proceed to [domain] (unsafe)"

**Firefox:**
Click "Advanced" → "Accept the Risk and Continue"

**Safari:**
Click "Show Details" → "visit this website"

**Mobile:**
Tap "Advanced" or "Details" → "Proceed" or "Visit this website"

This is normal for self-hosted services and safe on your local network.

### Accessing Services

Once DNS is configured:
1. Open browser
2. Navigate to `https://glance.home.local` (or any service)
3. Accept SSL warning on first visit
4. Bookmark for easy access!

### Troubleshooting

See [TROUBLESHOOTING.md](TROUBLESHOOTING.md#domain-access-issues) for common DNS and certificate issues.
```

### 3. docs/CONFIGURATION.md

Add new section:

```markdown
## Traefik Reverse Proxy Configuration

### Overview

Traefik provides domain-based routing for all services using Docker labels for automatic service discovery.

### Configuration Files

- **docker-compose.yml** - Contains Traefik service definition and labels for core services
- **docker-compose.monitoring.yml** - Contains labels for monitoring services
- **docker-compose.habitica.yml** - Contains labels for Habitica
- **external/bookwyrm-docker/docker-compose.yml** - Contains labels for Bookwyrm

### Adding New Services

To add a new service with domain access:

1. Add service to docker-compose.yml
2. Connect to `homeserver` network
3. Add Traefik labels:

```yaml
services:
  myservice:
    image: myservice:latest
    container_name: myservice
    networks:
      - homeserver
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.myservice.rule=Host(`myservice.home.local`)"
      - "traefik.http.routers.myservice.entrypoints=websecure"
      - "traefik.http.routers.myservice.tls=true"
      - "traefik.http.services.myservice.loadbalancer.server.port=8080"  # Internal port
```

4. Add DNS rewrite to AdGuard (already covered by wildcard `*.home.local`)
5. Deploy: `docker compose up -d myservice`

### Traefik Dashboard

Access Traefik's dashboard at `https://traefik.home.local`

**Login credentials:**
- Username: admin
- Password: (set during Traefik deployment)

The dashboard shows:
- Active routers and their rules
- Connected services and health
- Middleware configuration
- TLS certificate status
- Access logs

### SSL/TLS Configuration

Traefik automatically generates self-signed certificates for all services.

**Certificate storage:**
`data/traefik/certs/`

**To use Let's Encrypt (optional, for public access):**
Edit Traefik command in docker-compose.yml:
```yaml
command:
  # ... existing commands ...
  - "--certificatesresolvers.letsencrypt.acme.dnschallenge=true"
  - "--certificatesresolvers.letsencrypt.acme.dnschallenge.provider=your-dns-provider"
  - "--certificatesresolvers.letsencrypt.acme.email=your-email@example.com"
  - "--certificatesresolvers.letsencrypt.acme.storage=/certs/acme.json"
```

Then add to service labels:
```yaml
- "traefik.http.routers.myservice.tls.certresolver=letsencrypt"
```

### Middleware Configuration

Traefik supports middleware for common needs:

**Basic Auth:**
```yaml
- "traefik.http.middlewares.myauth.basicauth.users=admin:$$apr1$$..."
- "traefik.http.routers.myservice.middlewares=myauth"
```

**Rate Limiting:**
```yaml
- "traefik.http.middlewares.ratelimit.ratelimit.average=10"
- "traefik.http.routers.myservice.middlewares=ratelimit"
```

**IP Whitelist:**
```yaml
- "traefik.http.middlewares.whitelist.ipwhitelist.sourcerange=192.168.1.0/24"
- "traefik.http.routers.myservice.middlewares=whitelist"
```
```

### 4. docs/OPERATIONS.md

Add new section:

```markdown
## Managing Traefik Reverse Proxy

### Viewing Traefik Status

```bash
# Check Traefik container
docker ps | grep traefik

# View Traefik logs
docker logs traefik

# View access logs
tail -f data/traefik/logs/access.log

# Check Traefik health
docker inspect traefik | grep -A 10 Health
```

### Reloading Traefik Configuration

Traefik automatically detects Docker label changes. Just restart the service:

```bash
# Add/update labels in docker-compose.yml
nano docker-compose.yml

# Restart service with new labels
docker compose up -d servicename

# Traefik discovers changes automatically (no Traefik restart needed)
```

### Traefik Troubleshooting

**Check active routers:**
```bash
docker exec traefik traefik healthcheck
curl http://localhost:8080/api/http/routers | jq
```

**View service discovery:**
```bash
docker exec traefik cat /etc/traefik/traefik.yml
```

**Test routing manually:**
```bash
# Test HTTP redirect
curl -I http://servicename.home.local

# Test HTTPS access
curl -Ik https://servicename.home.local
```

### Common Traefik Issues

See [TROUBLESHOOTING.md](TROUBLESHOOTING.md#traefik-issues) for detailed solutions.
```

### 5. docs/ARCHITECTURE.md

Update architecture diagram:

```markdown
## Infrastructure Overview

```
┌─────────────────────────────────────────────────────────┐
│                    Local Network                        │
│                                                         │
│  ┌──────────┐         ┌──────────────────┐            │
│  │  Client  │────────>│  AdGuard Home    │            │
│  │  Device  │  DNS    │  (Port 53)       │            │
│  └──────────┘  Query  └──────────────────┘            │
│       │                        │                       │
│       │                   DNS Response                 │
│       │                   (SERVER_IP)                  │
│       │                        │                       │
│       v                        v                       │
│  ┌──────────────────────────────────────┐             │
│  │         Traefik Reverse Proxy        │             │
│  │         (Ports 80, 443)              │             │
│  │  ┌────────────────────────────────┐  │             │
│  │  │  Domain-based Router           │  │             │
│  │  │  - *.home.local → Services     │  │             │
│  │  │  - TLS Termination             │  │             │
│  │  │  - Automatic Service Discovery │  │             │
│  │  └────────────────────────────────┘  │             │
│  └──────────────────────────────────────┘             │
│                     │                                  │
│      ┌──────────────┼──────────────┬─────────────┐   │
│      │              │              │             │   │
│      v              v              v             v   │
│  ┌────────┐    ┌────────┐    ┌─────────┐   ┌──────┐│
│  │  n8n   │    │ Glance │    │Habitica │...│ More ││
│  │  5678  │    │  8080  │    │  8080   │   │      ││
│  └────────┘    └────────┘    └─────────┘   └──────┘│
│                                                      │
│  ┌────────────────────────────────────────────────┐ │
│  │         Docker Network: homeserver             │ │
│  └────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────┘
```

**Request Flow:**

1. Client requests `https://n8n.home.local`
2. AdGuard Home resolves to `SERVER_IP`
3. Request reaches Traefik on port 443
4. Traefik routes based on `Host` header to n8n container
5. n8n processes request and returns response
6. Traefik returns response to client over HTTPS

**Benefits:**
- Clean URLs (no ports to remember)
- Centralized SSL/TLS
- Easy to add new services
- Automatic service discovery
```

### 6. docs/TROUBLESHOOTING.md

Add new sections:

```markdown
## Domain Access Issues

### DNS Not Resolving

**Symptom:** `nslookup servicename.home.local` fails or returns wrong IP

**Solutions:**
```bash
# 1. Verify AdGuard DNS rewrites
cat data/adguard/conf/AdGuardHome.yaml | grep -A 5 rewrites

# 2. Verify client DNS settings
# Check your device is using SERVER_IP as DNS

# 3. Flush DNS cache on client
# Windows: ipconfig /flushdns
# macOS: sudo dscacheutil -flushcache
# Linux: sudo systemd-resolve --flush-caches

# 4. Test DNS directly
dig @SERVER_IP servicename.home.local +short
# Should return: SERVER_IP
```

### SSL Certificate Issues

**Symptom:** Browser blocks access, can't proceed past certificate warning

**Solutions:**

**Chrome "NET::ERR_CERT_INVALID" (can't proceed):**
- Type: `thisisunsafe` (no spaces) while on the error page
- Or use Firefox/Safari which allow easier bypassing

**Add certificate exception:**
1. Click certificate error details
2. Export certificate
3. Add to system trust store (advanced users only)

**Use mkcert for trusted local certificates (recommended for heavy use):**
```bash
# Install mkcert
# macOS: brew install mkcert
# Linux: apt install mkcert / yum install mkcert

# Create local CA
mkcert -install

# Generate certificates
mkcert -cert-file ssl/server.crt -key-file ssl/server.key "*.home.local" localhost 127.0.0.1

# Configure Traefik to use these certificates (see CONFIGURATION.md)
```

### Service Not Accessible via Domain

**Symptom:** `https://servicename.home.local` returns 404 or 502

**Solutions:**
```bash
# 1. Check service is running
docker ps | grep servicename

# 2. Check Traefik discovered the service
docker logs traefik | grep servicename

# 3. Verify Traefik labels
docker inspect servicename | grep -A 20 Labels

# 4. Check service port matches label
docker port servicename

# 5. Test direct container access
docker exec traefik wget -qO- http://servicename:PORT

# 6. Check Traefik routers
curl http://localhost:8080/api/http/routers | jq
```

## Traefik Issues

### 502 Bad Gateway

**Symptom:** Service returns 502 Bad Gateway error

**Causes & Solutions:**

1. **Service not running:**
   ```bash
   docker ps | grep servicename
   docker compose up -d servicename
   ```

2. **Wrong port in Traefik label:**
   ```bash
   # Check service's internal port
   docker port servicename

   # Verify label matches
   docker inspect servicename | grep "loadbalancer.server.port"
   ```

3. **Service not on same network:**
   ```bash
   # Check service is on homeserver network
   docker inspect servicename | grep -A 10 Networks
   ```

4. **Service not ready:**
   ```bash
   # Check health check
   docker inspect servicename | grep -A 10 Health

   # Give service more time to start
   docker logs servicename
   ```

### Traefik Not Discovering Service

**Symptom:** Service doesn't appear in Traefik dashboard

**Solutions:**
```bash
# 1. Verify traefik.enable=true label
docker inspect servicename | grep "traefik.enable"

# 2. Verify service on homeserver network
docker inspect servicename | grep -A 10 Networks

# 3. Restart service to trigger discovery
docker compose up -d servicename

# 4. Check Traefik logs for errors
docker logs traefik | grep -i error

# 5. Verify Docker socket mounted
docker inspect traefik | grep docker.sock
```

### Redirect Loop

**Symptom:** Browser shows "Too many redirects" error

**Solutions:**
```bash
# Check for conflicting redirect configurations
# Remove duplicate redirect middleware
# Ensure service doesn't force its own HTTPS redirect

# Check Traefik labels for duplicate redirects
docker inspect servicename | grep redirect
```
```

### 7. SERVICES.md

Update service access URLs:

```markdown
# Services Catalog

## Access Methods

All services are accessible via two methods:

1. **Domain-based (Recommended):** `https://servicename.home.local`
2. **IP:port (Legacy):** `http://SERVER_IP:PORT`

---

## Core Services

### AdGuard Home
- **Purpose:** Network-wide ad blocking and DNS server
- **Access:** https://adguard.home.local
- **Legacy:** http://SERVER_IP:8888
- **Port:** 8888 (admin), 53 (DNS)
- **Authentication:** Set during initial setup

### n8n
- **Purpose:** Workflow automation with AI
- **Access:** https://n8n.home.local
- **Legacy:** https://SERVER_IP:5678
- **Port:** 5678
- **Authentication:** N8N_USER / N8N_PASSWORD from .env

### Ollama
- **Purpose:** Local AI models API
- **Access:** https://ollama.home.local
- **Legacy:** http://SERVER_IP:11434
- **Port:** 11434
- **Authentication:** None
- **API Docs:** https://ollama.home.local/api

... (continue for all services)

---

## Management Services

### Traefik Dashboard
- **Purpose:** Reverse proxy management
- **Access:** https://traefik.home.local
- **Authentication:** Basic auth (admin / configured password)
- **Features:**
  - View active routers
  - Monitor service health
  - Check SSL certificates
  - View access logs

---

## Quick Reference

| Service | Domain | Legacy |
|---------|--------|--------|
| Traefik | https://traefik.home.local | N/A |
| AdGuard | https://adguard.home.local | http://IP:8888 |
| n8n | https://n8n.home.local | https://IP:5678 |
| Glance | https://glance.home.local | http://IP:8282 |
| ... | ... | ... |
```

## Testing Updates

```bash
# 1. Check all markdown files for broken links
find docs -name "*.md" -exec markdown-link-check {} \;

# 2. Verify all code blocks have correct syntax
# (manual review recommended)

# 3. Check for remaining references to old IP:port patterns
grep -r "http://.*:.*" docs/ | grep -v "Legacy:" | grep -v "example"

# 4. Ensure consistency
# All .home.local domains should use https://
# All legacy references should be marked as (Legacy)
```

## Documentation Checklist

- [ ] README.md updated with domain URLs
- [ ] SETUP.md includes domain setup instructions
- [ ] CONFIGURATION.md covers Traefik configuration
- [ ] OPERATIONS.md includes Traefik management
- [ ] ARCHITECTURE.md shows Traefik in diagram
- [ ] TROUBLESHOOTING.md has domain/Traefik sections
- [ ] SERVICES.md lists both access methods
- [ ] All IP:port references marked as legacy
- [ ] All examples use domain names
- [ ] SSL certificate warnings documented
- [ ] DNS setup instructions clear
- [ ] Makefile help text updated (if applicable)
- [ ] **Makefile DNS test output fixed** - Update `make adguard-setup` to use `${SERVER_IP}` instead of `127.0.0.1` for DNS testing (currently shows connection refused but DNS works correctly)
- [ ] **Makefile output cleaned up** - Ensure all make targets produce clean, professional output without misleading errors

## Success Metrics
- All documentation accurate and up-to-date
- New users can set up domain access from docs
- Troubleshooting covers common issues
- No broken links in documentation
- Consistent terminology throughout

## Dependencies
- Tickets 01-08: All technical implementation completed
- Services tested and validated
- Domain access fully functional

## Risk Considerations
- Outdated docs can confuse users
- Missing troubleshooting steps cause friction
- Inconsistent examples cause confusion

## Rollback Plan
N/A - Documentation can be updated anytime

## Next Steps
After completion:
- Share updated docs with users/team
- Consider creating video tutorial
- Add FAQ section if common questions emerge
- Keep docs updated as services are added

## Notes
- Use consistent formatting throughout
- Include both access methods for transition period
- Add "last updated" date to major docs
- Consider creating a migration guide for existing users
- Examples should be copy-paste ready
- Use actual domain names, not placeholders like `example.com`
