# Environment Files Reference

This document explains how environment files are used across the codebase.

## Environment Files

### `.env` (Production)
- Used on the server for production deployments
- Contains real credentials and API keys
- **Never committed to git** (in `.gitignore`)
- Required for: `make setup`, `make start`, all production operations

### `.env.local` (Local Development)
- Used on your Mac for local testing
- Contains test/dummy values
- **Never committed to git** (in `.gitignore`)
- Required for: `make local-setup`, `make local-start`, all local operations
- Created from `.env.local.example`

### `.env.example` (Template for Production)
- Template for production `.env`
- Contains example values and documentation
- **Committed to git**
- Used to create production `.env`

### `.env.local.example` (Template for Local)
- Template for local `.env.local`
- Contains safe default values for local testing
- **Committed to git**
- Used to create `.env.local`

## Scripts Supporting Both Environments

These scripts have been updated to support `ENV_FILE` variable:

| Script | Usage | Environment Support |
|--------|-------|-------------------|
| `configure-homepage.sh` | Setup Homepage dashboard | ✅ Both (via ENV_FILE) |
| `setup-homeassistant.sh` | Setup Home Assistant | ✅ Both (via ENV_FILE) |
| `setup-traefik-password.sh` | Generate Traefik password | ✅ Both (via ENV_FILE) |

**How it works:**
- Default behavior: Uses `.env`
- Override: Set `ENV_FILE=.env.local` before calling script
- Example: `ENV_FILE=.env.local ./scripts/configure-homepage.sh`

## Production-Only Scripts

These scripts **only** use `.env` and should **not** be run locally:

| Script | Purpose | Why Production-Only |
|--------|---------|-------------------|
| `setup-certbot-gandi.sh` | SSL certificate setup | Requires domain and Gandi API |
| `copy-certs-to-traefik.sh` | Copy SSL certificates | No SSL in local mode |
| `configure-traefik-file-provider.sh` | Configure Traefik SSL | No SSL in local mode |
| `setup-cert-renewal.sh` | Setup auto-renewal | No SSL in local mode |
| `setup-adguard-dns.sh` | Configure DNS rewrites | AdGuard disabled locally |
| `setup-wireguard-routing.sh` | Setup VPN routing | WireGuard disabled locally |
| `setup-firewall.sh` | Configure UFW firewall | Linux-only, server security |
| `test-domain-access.sh` | Test domain routing | No domain routing locally |

## Makefile Targets

### Local Development (uses `.env.local`)
```bash
make local-setup      # ENV_FILE=.env.local
make local-start      # Uses docker-compose.local.yml --env-file .env.local
make local-stop
make local-restart
make local-logs
make local-status
make local-clean
```

### Production (uses `.env`)
```bash
make setup            # ENV_FILE=.env
make start            # Uses default .env
make stop
make restart
make logs
make status
```

### Deployment
```bash
make deploy SERVER=user@host    # Deploys to server (server uses .env)
```

## Adding New Scripts

When creating new scripts that load environment variables:

### Option 1: Support Both Environments (Recommended for General Tools)

```bash
#!/bin/bash
set -e

# Load environment variables (support both .env and .env.local)
ENV_FILE="${ENV_FILE:-.env}"

if [ ! -f "$ENV_FILE" ]; then
    echo "ERROR: $ENV_FILE file not found"
    exit 1
fi

echo "Using environment file: $ENV_FILE"
source "$ENV_FILE"

# Your script logic here...
```

Then in Makefile:
```makefile
# Production target
my-target:
    @ENV_FILE=.env ./scripts/my-script.sh

# Local target (if needed)
local-my-target:
    @ENV_FILE=.env.local ./scripts/my-script.sh
```

### Option 2: Production-Only (For SSL, DNS, VPN, etc.)

```bash
#!/bin/bash
set -e

# Load environment variables
if [ ! -f .env ]; then
    echo "ERROR: .env file not found"
    exit 1
fi

source .env

# Your production-only logic here...
```

## Verification

Check which scripts support ENV_FILE:
```bash
grep -l "ENV_FILE=" scripts/*.sh
```

Check which scripts are production-only:
```bash
grep -l "source \.env" scripts/*.sh | while read f; do
    if ! grep -q "ENV_FILE" "$f"; then
        echo "$f (production-only)"
    fi
done
```

## Common Issues

### Issue: Script can't find `.env`
**Solution:** You're likely trying to run a production script locally.
- Check if the script is in the "Production-Only" list above
- Use the appropriate `make local-*` command instead

### Issue: Variables not loading
**Solution:** Ensure you're using the correct environment file
- Local: `ENV_FILE=.env.local ./scripts/script.sh`
- Production: `ENV_FILE=.env ./scripts/script.sh` (or just `./scripts/script.sh`)

### Issue: Script modifying wrong .env file
**Solution:** Check that script uses `$ENV_FILE` not hardcoded `.env`
- Example: `echo "VAR=value" >> "$ENV_FILE"` ✅
- Example: `echo "VAR=value" >> .env` ❌

## Best Practices

1. **Never commit `.env` or `.env.local`** - They contain secrets
2. **Always update `.env.example` and `.env.local.example`** when adding variables
3. **Test locally first** before deploying to production
4. **Document production-only requirements** in script comments
5. **Use ENV_FILE pattern** for scripts that could be useful in both environments
6. **Keep production-only scripts simple** - Don't add ENV_FILE support if not needed
