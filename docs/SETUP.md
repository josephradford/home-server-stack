# Setup Guide

Complete installation and initial configuration guide for the Home Server Stack.

## Prerequisites

Before starting, ensure you have:
- A dedicated server or machine running Linux (tested on Ubuntu Server 24.04 LTS)
- Docker and Docker Compose installed
- Static IP address configured for your server
- Root or sudo access
- See [REQUIREMENTS.md](REQUIREMENTS.md) for detailed system requirements

## Installation Steps

### 1. Clone the Repository

```bash
git clone <your-repo-url>
cd home-server-stack
```

### 2. Setup User Permissions

To run Docker commands without `sudo`, add your user to the docker group. This is a **one-time setup** that persists across reboots.

```bash
./scripts/setup-user-permissions.sh
```

**What this does:**
- Adds your current user to the `docker` group
- Allows running `docker` and `make` commands without `sudo`
- Simplifies day-to-day operations

**Important:** After running this script, you must **logout and login again** for the change to take effect.

Alternatively, to apply the change in your current session only:
```bash
newgrp docker
```

**Verify it works:**
```bash
# After logging back in, this should work without sudo:
docker ps
```

**Note:** If you skip this step, you'll need to prefix all `docker` and `make` commands with `sudo`:
```bash
sudo make setup
sudo docker compose ps
```

### 3. Configure Environment Variables

```bash
cp .env.example .env
nano .env
```

**Required Configuration:**

| Variable | Description | Example |
|----------|-------------|---------|
| `SERVER_IP` | Your server's local IP address | `192.168.1.100` |
| `TIMEZONE` | Your local timezone | `America/New_York`, `Europe/London`, `UTC` |
| `N8N_USER` | Username for n8n access | `admin` |
| `N8N_PASSWORD` | Secure password for n8n | `your_secure_password_here` |
| `N8N_EDITOR_BASE_URL` | External domain for n8n | `https://your-domain:5678` |

**Optional Configuration:**

| Variable | Description | Default |
|----------|-------------|---------|
| `GRAFANA_PASSWORD` | Grafana admin password | `your_secure_grafana_password` |
| `N8N_RUNNERS_TASK_TIMEOUT` | n8n task timeout (seconds) | `1800` |

See [CONFIGURATION.md](CONFIGURATION.md) for detailed configuration options.

### 4. Deploy Stack

Run the automated setup which will:
- Generate SSL certificates automatically (for n8n HTTPS)
- Pull and start all services (core + monitoring)

```bash
make setup
```

**What happens during setup:**
- ✅ Environment validation (`.env` file check)
- ✅ SSL certificate generation (if not present)
- ✅ Docker Compose validation
- ✅ Image pulling
- ✅ Services deployment (AdGuard, n8n, WireGuard, Traefik, Grafana, Prometheus, etc.)

**Note:** SSL certificates are automatically generated for localhost. To regenerate with a custom domain:
```bash
make regenerate-ssl DOMAIN=your-domain.ddns.net
make restart  # Restart services to use new certificates
```

For production TLS certificates, see [security-tickets/04-tls-certificate-monitoring.md](../security-tickets/04-tls-certificate-monitoring.md).

## Domain-Based Access Setup

The home server uses Traefik reverse proxy to provide clean domain-based URLs for all services.

### How It Works

1. **Traefik** acts as a reverse proxy, routing requests based on domain names
2. **AdGuard Home** provides DNS resolution for `*.home.local` domains
3. **Self-signed SSL certificates** are automatically generated by Traefik

### DNS Configuration

Your client devices need to use AdGuard Home as their DNS server:

**Option 1: DHCP (Recommended)**
Configure your router's DHCP to point to AdGuard Home:
- Primary DNS: `SERVER_IP` (e.g., 192.168.1.100)
- Secondary DNS: 1.1.1.1 or 8.8.8.8 (for redundancy)

**Option 2: Manual Configuration**
Set DNS manually on each device to `SERVER_IP`

**Verify DNS Setup:**
```bash
nslookup n8n.home.local
# Should return: SERVER_IP
```

### SSL Certificate Warnings

Since certificates are self-signed for local use, you'll see security warnings:

**Chrome/Edge:**
Click "Advanced" → "Proceed to [domain] (unsafe)"

**Firefox:**
Click "Advanced" → "Accept the Risk and Continue"

**Safari:**
Click "Show Details" → "visit this website"

**Mobile:**
Tap "Advanced" or "Details" → "Proceed" or "Visit this website"

This is normal for self-hosted services and safe on your local network.

### Accessing Services

Once DNS is configured:
1. Open browser
2. Navigate to `https://n8n.home.local` or `https://grafana.home.local`
3. Accept SSL warning on first visit
4. Bookmark for easy access!

### Troubleshooting

See [TROUBLESHOOTING.md](TROUBLESHOOTING.md#domain-access-issues) for common DNS and certificate issues.

### 4. Verify Deployment

Check that all services are running:

```bash
make status
```

Expected output includes:
- adguard-home
- n8n
- traefik
- wireguard
- grafana, prometheus, alertmanager, node-exporter, cadvisor

View logs to check for errors:
```bash
make logs
```

Or view specific service logs:
```bash
make logs-n8n
make logs-wireguard
docker logs traefik
docker logs grafana
```

## Initial Configuration

### AdGuard Home Setup

1. Navigate to `http://SERVER_IP:3000`
2. Click "Get Started" in the setup wizard
3. **Admin Web Interface:**
   - Interface: All interfaces
   - Port: `80` (default)
4. **DNS Server:**
   - Interface: All interfaces
   - Port: `53` (default)
5. **Create Admin Account:**
   - Set admin username
   - Set a strong password
6. Click "Next" through remaining steps
7. After setup, access admin panel at `http://SERVER_IP:80`

**Recommended Settings:**
- **Filters > DNS blocklists:** Enable default lists
- **Settings > DNS settings:**
  - Upstream DNS: `1.1.1.1`, `8.8.8.8`
  - Enable parallel requests
  - Enable DNSSEC
- **Settings > Encryption:** Keep disabled for local network (VPN handles encryption)

### n8n Setup

1. Navigate to `https://SERVER_IP:5678`
2. Accept the self-signed certificate warning:
   - Chrome/Edge: Click "Advanced" → "Proceed to [your-domain] (unsafe)"
   - Firefox: Click "Advanced" → "Accept the Risk and Continue"
3. Login with credentials from `.env` file:
   - Username: Value from `N8N_USER`
   - Password: Value from `N8N_PASSWORD`
4. You'll see the n8n welcome screen
5. Create your first workflow or explore templates

**First Steps in n8n:**
- Click "New workflow" to start from scratch
- Or browse "Templates" for pre-built workflows
- Set up integrations with external services

### WireGuard VPN Setup

WireGuard automatically generates peer configurations on first run.

**Get Client Configuration:**

```bash
# View all peer configs
docker exec wireguard ls /config/peer*

# Display QR code for mobile (peer1)
docker exec wireguard /app/show-peer 1

# Get config file for desktop (peer1)
docker exec wireguard cat /config/peer1/peer1.conf
```

**Connect Clients:**

1. **Mobile (iOS/Android):**
   - Install WireGuard app
   - Scan QR code displayed above
   - Enable the connection

2. **Desktop (Windows/macOS/Linux):**
   - Install WireGuard client
   - Import the `.conf` file
   - Activate the tunnel

After connecting, verify VPN access:
```bash
# From VPN client, test accessing internal services
curl http://192.168.1.100:80  # AdGuard
curl https://192.168.1.100:5678  # n8n
```

See [REMOTE_ACCESS.md](REMOTE_ACCESS.md) for advanced VPN configuration.

## Monitoring Stack

The monitoring stack is automatically deployed and provides comprehensive observability:

### Access Grafana

1. Navigate to `http://SERVER_IP:3001`
2. Login with:
   - Username: `admin`
   - Password: Value from `GRAFANA_PASSWORD` in `.env`
3. Navigate to **Dashboards** → **Browse**
4. Open pre-configured dashboards:
   - **System Overview** - CPU, memory, disk, network metrics
   - **Container Health** - Docker container status and resources
   - **Resource Utilization** - Historical trends and top consumers

### Verify Prometheus

1. Navigate to `http://SERVER_IP:9090`
2. Go to **Status** → **Targets**
3. Verify all targets are "UP":
   - prometheus
   - node-exporter
   - cadvisor
   - adguard
   - n8n (if configured)
   - ollama (if configured)

### Configure Alertmanager

Alertmanager is pre-configured to send alerts to a webhook at `http://127.0.0.1:5001/`.

To configure email/Slack/other notifications:

```bash
nano monitoring/alertmanager/alertmanager.yml
```

See [MONITORING_DEPLOYMENT.md](MONITORING_DEPLOYMENT.md) for detailed monitoring setup.

## Post-Installation

### Security Checklist

- [ ] Changed all default passwords
- [ ] Generated strong SSL certificates
- [ ] Reviewed `.env` file (no secrets committed)
- [ ] Configured firewall rules (if applicable)
- [ ] WireGuard VPN configured and tested
- [ ] Reviewed [security-tickets/README.md](../security-tickets/README.md) for hardening roadmap

### Network Configuration

**For local-only access (recommended):**
- No additional configuration needed
- Access all services via local IP or VPN

**For remote access (not recommended without VPN):**
- See [REMOTE_ACCESS.md](REMOTE_ACCESS.md) for port forwarding
- **Warning:** Only expose services you absolutely need externally
- Use WireGuard VPN for secure remote access instead

### Backup Configuration

Set up regular backups of your data:

```bash
# Create backup directory
mkdir -p ~/backups

# Backup data volumes
sudo tar -czf ~/backups/homeserver-$(date +%Y%m%d).tar.gz ./data/

# Backup configurations
cp .env ~/backups/.env.$(date +%Y%m%d)
```

Consider automating backups with cron (see [security-tickets/10-automated-backups.md](../security-tickets/10-automated-backups.md)).

## Next Steps

1. **Configure DNS:**
   - Update your router to use AdGuard Home as DNS server
   - Or configure device-specific DNS settings

2. **Create n8n Workflows:**
   - Explore n8n templates
   - Set up integrations with external services
   - Configure webhooks for automation

3. **Harden Security:**
   - Follow [security-tickets/README.md](../security-tickets/README.md)
   - Start with Phase 1 (Critical) tickets
   - Implement VPN-first access strategy

4. **Review Monitoring:**
   - Check Grafana dashboards
   - Configure additional alerts if needed
   - Review Prometheus metrics

## Troubleshooting

If you encounter issues during setup, see [TROUBLESHOOTING.md](TROUBLESHOOTING.md) for common problems and solutions.

**Quick Checks:**

```bash
# Check service status
docker compose ps

# View service logs
docker compose logs [service_name]

# Restart a service
docker compose restart [service_name]

# Verify Docker is running
sudo systemctl status docker

# Check port availability
sudo netstat -tlnp | grep -E ':(53|80|443|5678|51820)'
```

## Support

- **Documentation:** [docs/](.) directory
- **Issues:** [GitHub Issues](https://github.com/josephradford/home-server-stack/issues)
- **Service Docs:** [AdGuard](https://adguard.com/kb/), [n8n](https://docs.n8n.io/), [Traefik](https://doc.traefik.io/traefik/)
