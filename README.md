# Home Server Stack

A complete self-hosted infrastructure for home automation, AI, and network services using Docker Compose.

## üöÄ Services

**Core Services:**
- **[AdGuard Home](https://github.com/AdguardTeam/AdGuardHome)** - Network-wide ad blocking and DNS server
- **[n8n](https://github.com/n8n-io/n8n)** - Workflow automation platform
- **[WireGuard](https://github.com/wireguard)** - VPN for secure remote access
- **[Traefik](https://github.com/traefik/traefik)** - Reverse proxy for domain-based service access

**Monitoring Stack:**
- **[Grafana](https://github.com/grafana/grafana)** - Metrics visualization and dashboards
- **[Prometheus](https://github.com/prometheus/prometheus)** - Metrics collection and alerting
- **[Alertmanager](https://github.com/prometheus/alertmanager)** - Alert routing and management
- **[Node Exporter](https://github.com/prometheus/node_exporter)** - System metrics exporter
- **[cAdvisor](https://github.com/google/cadvisor)** - Container metrics

See [SERVICES.md](SERVICES.md) for the complete catalog including planned services.

## üìã Quick Start

```bash
# 1. Clone the repository
git clone <your-repo-url>
cd home-server-stack

# 2. Configure environment
cp .env.example .env
nano .env  # Update SERVER_IP, TIMEZONE, passwords

# 3. Run first-time setup (includes all services + monitoring)
make setup

# 4. Setup Let's Encrypt SSL certificates (optional, for trusted certificates)
# Required environment variables: DOMAIN, ACME_EMAIL, GANDIV5_PERSONAL_ACCESS_TOKEN
make ssl-setup
```

**SSL Certificate Options:**

By default, Traefik uses self-signed certificates for local network use:
- You'll need to accept security warnings in your browser on first visit
- This is normal and expected for local-only services
- For browsers that don't allow proceeding, see [TROUBLESHOOTING.md](docs/TROUBLESHOOTING.md#ssl-certificate-issues)

**For trusted Let's Encrypt certificates:**
- If you own a domain and want trusted SSL certificates, use `make ssl-setup`
- Requires domain hosted on Gandi with API access
- See [SSL Certificate Setup](#ssl-certificate-setup) section below for details

**Using the Makefile:**
- `make help` - Show all available commands
- `make setup` - First time setup (all services + monitoring)
- `make update` - Update all services to latest versions
- `make start` - Start all services
- `make stop` - Stop all services
- `make logs` - View logs from all services
- See `make help` for complete list of commands

**Access Services:**

All services are accessible via domain names on your local network:

- **Traefik Dashboard:** `https://traefik.home.local`
- **AdGuard Home:** `https://adguard.home.local` (DNS admin)
- **n8n:** `https://n8n.home.local` (Workflow automation)
- **Grafana:** `https://grafana.home.local` (Monitoring)
- **Prometheus:** `https://prometheus.home.local` (Metrics)
- **Alertmanager:** `https://alerts.home.local` (Alerts)

**Note:** Services are accessible via domain names thanks to Traefik reverse proxy and AdGuard Home DNS. Your devices must use AdGuard Home as their DNS server (configured automatically if DHCP points to the server).

**Direct IP Access:** Some services remain accessible via IP:port for specific operational needs:
- AdGuard Home: `http://SERVER_IP:8888` (emergency access if Traefik fails)
- Prometheus: `http://SERVER_IP:9090` (metrics scraping)
- Alertmanager: `http://SERVER_IP:9093` (alert management)
- See [SERVICES.md](SERVICES.md) for complete list

See **[docs/SETUP.md](docs/SETUP.md)** for detailed installation instructions.

## üîí SSL Certificate Setup

This stack supports two SSL certificate options:

### Option 1: Self-Signed Certificates (Default)
- Automatically generated by Traefik
- Works out of the box, no configuration needed
- Requires accepting browser security warnings
- Suitable for local network use only

### Option 2: Let's Encrypt Trusted Certificates
For trusted SSL certificates that don't require browser warnings:

**Prerequisites:**
- Own a domain name (e.g., `example.com`)
- Domain hosted on [Gandi](https://www.gandi.net/)
- Gandi Personal Access Token with "Manage domain name technical configurations" permission

**Environment Variables:**
Add these to your `.env` file:
```bash
DOMAIN=example.com
ACME_EMAIL=your-email@example.com
GANDIV5_PERSONAL_ACCESS_TOKEN=your-gandi-token
```

**Setup:**
```bash
# Complete SSL setup (installs certbot, generates certs, configures auto-renewal)
make ssl-setup

# Or run individual steps:
make ssl-copy-certs           # Copy certs to Traefik
make ssl-configure-traefik    # Configure Traefik file provider
make ssl-setup-renewal        # Setup auto-renewal
make ssl-renew-test          # Test renewal (dry run)
```

**Implementation Details:**

This setup uses **certbot with the Gandi DNS plugin** instead of Traefik's built-in ACME integration. Here's why:

**Why certbot instead of Traefik ACME?**
- Traefik v3.2's Lego library (v4.21.0) has compatibility issues with Gandi API v5
- Manual API tests succeed, but Lego consistently returns 403 errors during DNS-01 challenge
- certbot with `certbot-dns-gandi` plugin works reliably with the same credentials
- See `scripts/setup-certbot-gandi.sh` for implementation details

**How it works:**
1. certbot generates wildcard certificate for `*.DOMAIN` and `DOMAIN` via DNS-01 challenge
2. Certificates stored in `/etc/letsencrypt/live/DOMAIN/`
3. Copied to `./data/traefik/certs/` for Traefik access
4. Traefik configured to use file provider instead of built-in ACME
5. Post-renewal hook automatically copies renewed certs and reloads Traefik

**Auto-Renewal:**
- certbot runs twice daily via snap timer
- Certificates renewed 30 days before expiry
- Post-renewal hook copies new certs to Traefik and restarts container
- Check logs: `sudo tail -f /var/log/certbot-traefik-reload.log`

**Certificate Details:**
- Wildcard certificate covers `*.DOMAIN` and `DOMAIN`
- Valid for 90 days, auto-renews at 60 days
- Issued by Let's Encrypt
- Trusted by all major browsers

## üìö Documentation

### Getting Started
- **[Setup Guide](docs/SETUP.md)** - Complete installation and initial setup
- **[Configuration Guide](docs/CONFIGURATION.md)** - Service configuration and customization
- **[Requirements](docs/REQUIREMENTS.md)** - System requirements and resource usage

### Operations
- **[Operations Guide](docs/OPERATIONS.md)** - Managing services, updates, backups
- **[Troubleshooting](docs/TROUBLESHOOTING.md)** - Common issues and solutions
- **[Monitoring Deployment](docs/MONITORING_DEPLOYMENT.md)** - Optional monitoring stack setup

### Monitoring & Alerts
- **[Alerts Reference](docs/ALERTS.md)** - Alert definitions and response procedures
- **[Operations Runbook](docs/RUNBOOK.md)** - Detailed troubleshooting for all alerts
- **[Known Issues](docs/KNOWN_ISSUES.md)** - Known bugs and workarounds

### Advanced
- **[Remote Access Setup](docs/REMOTE_ACCESS.md)** - Port forwarding and VPN configuration
- **[Architecture Overview](docs/ARCHITECTURE.md)** - System design and data persistence

### Implementation Tickets
- **[Monitoring Tickets](monitoring-tickets/README.md)** - Monitoring implementation roadmap
- **[Security Tickets](security-tickets/README.md)** - Security hardening roadmap (VPN-first strategy)

## üîê Security

This project follows a **VPN-first security model**. See [security-tickets/README.md](security-tickets/README.md) for the complete security roadmap.

**Key Security Features:**
- VPN-first access (WireGuard primary boundary)
- Selective public exposure (n8n webhooks only)
- Pre-commit secret scanning
- Pinned Docker image versions
- Regular security audits

See **[SECURITY.md](SECURITY.md)** for security policy and reporting vulnerabilities.

## ü§ù Contributing

Contributions are welcome! See **[CONTRIBUTING.md](CONTRIBUTING.md)** for guidelines on:
- Submitting bug reports and feature requests
- Development workflow and branching strategy
- Pull request process

## üìä System Requirements

**Minimum:**
- 8 GB RAM (16 GB recommended)
- 500 GB storage (1 TB recommended)
- Linux-based OS (tested on Ubuntu Server 24.04 LTS)
- Docker and Docker Compose installed

See **[docs/REQUIREMENTS.md](docs/REQUIREMENTS.md)** for detailed requirements.

## üìÑ License

This project is open source. Individual services maintain their own licenses:
- AdGuard Home: GPL-3.0
- n8n: Fair-code (Sustainable Use License)
- Traefik: MIT
- Grafana: AGPL-3.0
- Prometheus: Apache-2.0

## üí¨ Support

- **Documentation**: Check the [docs/](docs/) directory
- **Issues**: [GitHub Issues](https://github.com/josephradford/home-server-stack/issues)
- **Service-specific docs**:
  - [AdGuard Home](https://adguard.com/kb/)
  - [n8n](https://docs.n8n.io/)
  - [Traefik](https://doc.traefik.io/traefik/)

---

**Project Status:** Active Development
**Latest Update:** 2025-10-16
